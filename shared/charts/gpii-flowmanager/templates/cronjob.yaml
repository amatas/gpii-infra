{{- if .Values.sslCertCheck.host }}
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: {{ template "flowmanager.name" . }}
  labels:
    app: {{ template "flowmanager.name" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  schedule: "{{ .Values.sslCertCheck.cronJobSchedule }}"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Replace
  startingDeadlineSeconds: 200
  jobTemplate:
    spec:
      activeDeadlineSeconds: 100
      template:
        metadata:
          labels:
            app: {{ template "flowmanager.name" . }}
            release: {{ .Release.Name }}
          annotations:
            # This annotation is needed to allow traffic to metadata.google.internal
            # until Istio's issue with FQDNs in ServiceEntries is not resolved:
            # https://github.com/istio/istio/issues/14404
            traffic.sidecar.istio.io/excludeOutboundIPRanges: "169.254.169.254/32"
        spec:
          shareProcessNamespace: true
          containers:
          - name: ssl-cert-check
            image: "{{ .Values.sslCertCheck.image.repository }}:{{ .Values.sslCertCheck.image.tag }}"
            env:
              - name: TARGET_HOST
                value: "{{ .Values.sslCertCheck.host }}"
              - name: TARGET_PORT
                value: "{{ .Values.sslCertCheck.port }}"
              - name: RENEWAL_WINDOW
                value: "{{ .Values.sslCertCheck.renewalWindow }}"
              # Sleep is needed to give istio-proxy time to start,
              # otherwise ssl-cert-check will fail with connection refused error.
              - name: SLEEP
                value: "10"
          - name: prometheus-to-sd
            image: "{{ .Values.prometheusToSdExporter.image.repository }}:{{ .Values.prometheusToSdExporter.image.tag }}"
            imagePullPolicy: {{ .Values.image.pullPolicy }}
            command:
              - /monitor
              - --stackdriver-prefix=custom.googleapis.com
              - --source=ssl-cert-check:http://localhost:{{ .Values.prometheusToSdExporter.port }}?auto-whitelist-metrics=true
              - --pod-id=$(POD_NAME)
              - --namespace-id=$(POD_NAMESPACE)
            env:
              - name: POD_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.name
              - name: POD_NAMESPACE
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.namespace
          restartPolicy: OnFailure
{{- end }}
